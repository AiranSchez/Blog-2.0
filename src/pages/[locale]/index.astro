---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/layout/Header.astro';
import Footer from '../../components/layout/Footer.astro';
import Parallax from '../../components/decorators/Parallax.tsx';
import ScrollReveal from '../../components/decorators/ScrollReveal.tsx';
import AuroraBackground from '../../components/decorators/AuroraBackground.tsx';
import Card from '../../components/ui/Card.astro';
import Badge from '../../components/ui/Badge.astro';
import Link from '../../components/ui/Link.astro';
import Input from '../../components/ui/Input.astro';
import Textarea from '../../components/ui/Textarea.astro';
import Button from '../../components/ui/Button.astro';
import AnimatedText from '../../components/ui/AnimatedText.tsx';
import MagneticButton from '../../components/ui/MagneticButton.tsx';
import { getCollection } from 'astro:content';
import { getLangFromUrl, useTranslations } from '../../logic/i18n-engine';

export const prerender = true;

export function getStaticPaths() {
  return [
    { params: { locale: 'en' } },
    { params: { locale: 'es' } },
    { params: { locale: 'ja' } }
  ];
}

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Get content
const allExperiences = await getCollection('experience');
const experiences = allExperiences
  .filter(exp => exp.data.locale === lang)
  .sort((a, b) => {
    // Sort by startDate descending (most recent first)
    return b.data.startDate.localeCompare(a.data.startDate);
  });

const allProjects = await getCollection('projects');
const projects = allProjects.filter(proj => proj.data.locale === lang && proj.data.featured);

const allPosts = await getCollection('blog');
const recentPosts = allPosts
  .filter(post => !post.data.draft && post.id.startsWith(`${lang}/`))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 3);

const aboutEntry = await getCollection('about');
const about = aboutEntry.find(entry => entry.id === `${lang}.mdx`);
const { Content: AboutContent } = about ? await about.render() : { Content: null };

import { Image } from 'astro:assets';
import profileImage from '../../assets/images/profile/DSC01226.jpg';
import aboutImage from '../../assets/images/profile/DSC01235.jpg';
---

<Layout title={`Airán - ${t('hero.subtitle')}`} description={t('hero.subtitle')} lang={lang}>
  <Header />
  
  <main id="main-content" class="relative">
    <!-- Hero Section with Parallax -->
    <Parallax speed={0.3} client:load>
      <AuroraBackground 
        className="min-h-[calc(100vh-5rem)]"
        client:load
      >
        <section class="min-h-[calc(100vh-5rem)] flex items-center justify-center relative">
          <div class="container mx-auto px-4 sm:px-6 max-w-4xl relative">
          <div class="grid md:grid-cols-2 gap-8 md:gap-12 items-center">
            <!-- Text Content (Left) -->
            <div class="text-center md:text-left">
              <h1 class="text-4xl sm:text-5xl md:text-7xl font-bold text-white mb-4">
                <AnimatedText 
                  text={t('hero.greeting')} 
                  variant="fade"
                  client:load
                />
                {' '}
                <AnimatedText 
                  text="Airán" 
                  variant="slideUp"
                  delay={0.3}
                  className="text-alabaster"
                  client:load
                />
              </h1>
              <p class="text-xl sm:text-2xl md:text-3xl text-alabaster/90 mb-8">
                <AnimatedText 
                  text={t('hero.subtitle')}
                  variant="fade"
                  delay={0.6}
                  client:load
                />
              </p>
              <div class="flex flex-col sm:flex-row gap-4 justify-center md:justify-start">
                <MagneticButton 
                  href={`/${lang}/blog/`}
                  className="px-6 py-4 min-h-[48px] bg-white text-stormy rounded-lg font-semibold hover:bg-alabaster transition-colors text-center"
                  client:load
                >
                  {t('nav.blog')}
                </MagneticButton>
                <MagneticButton 
                  href="#contact"
                  className="px-6 py-4 min-h-[48px] border-2 border-white text-white rounded-lg font-semibold hover:bg-white/10 transition-colors text-center"
                  client:load
                >
                  {t('nav.contact')}
                </MagneticButton>
              </div>
            </div>
            
            <!-- Hero Image (Right) -->
            <div class="flex justify-center md:justify-end mt-8 md:mt-0">
              <div class="relative">
                <Image 
                  src={profileImage} 
                  alt="Airán Sanchez" 
                  width={400} 
                  height={400}
                  loading="eager"
                  fetchpriority="high"
                  class="rounded-full shadow-2xl ring-4 ring-white/20 w-64 h-64 sm:w-80 sm:h-80 md:w-full md:h-full object-cover"
                />
                <!-- Decorative elements around image -->
                <div class="absolute top-4 left-4 w-full h-full rounded-full bg-seaweed/30 blur-xl -z-10"></div>
              </div>
            </div>
          </div>
        </div>
      </section>
      </AuroraBackground>
    </Parallax>

    <!-- Projects Section -->
    <Parallax speed={-0.2} client:load>
      <section class="py-12 sm:py-20 bg-alabaster dark:bg-carbon transition-colors relative shadow-2xl" aria-labelledby="projects-heading">
      <div class="container mx-auto px-4 sm:px-6 max-w-7xl">
        <h2 id="projects-heading" class="text-4xl font-bold text-center mb-12 text-stormy dark:text-seaweed">
          {t('projects.title')}
        </h2>
        <div class="grid md:grid-cols-2 gap-6 sm:gap-8">
          {projects.map((project, index) => (
            <ScrollReveal 
              delay={index * 0.2}
              direction="up"
              client:load
            >
              <article 
                class="group transition-transform duration-300 hover:-translate-y-1 focus-within:ring-2 focus-within:ring-stormy rounded-lg"
                data-project-card
              >
                <Card 
                  variant="elevated" 
                  padding="lg"
                  class="h-full flex flex-col"
                >
                  <h3 class="text-2xl font-bold mb-3 text-stormy dark:text-seaweed">
                    {project.data.title}
                  </h3>
                  <p class="text-carbon/80 dark:text-alabaster/80 mb-4 flex-grow">
                    {project.data.description}
                  </p>
                  <div class="flex flex-wrap gap-2 mb-4" role="list" aria-label="Technologies">
                    {project.data.tech.map((tech) => (
                      <Badge 
                        variant="secondary" 
                        size="sm"
                        role="listitem"
                      >
                        {tech}
                      </Badge>
                    ))}
                  </div>
                  <div class="flex gap-4">
                    {project.data.githubUrl && (
                      <Link 
                        href={project.data.githubUrl}
                        variant="default"
                        class="hover:underline"
                      >
                        {t('projects.viewGithub')}
                      </Link>
                    )}
                    {project.data.demoUrl && (
                      <Link 
                        href={project.data.demoUrl}
                        variant="default"
                        class="hover:underline"
                      >
                        {t('projects.viewDemo')}
                      </Link>
                    )}
                  </div>
                </Card>
              </article>
            </ScrollReveal>
          ))}
        </div>
      </div>
    </section>
    </Parallax>

    <!-- Experience Section -->
    <Parallax speed={0.4} client:load>
    <AuroraBackground className="py-12 sm:py-20" client:load>
    <section class="py-12 sm:py-20 transition-colors relative" aria-labelledby="experience-heading">
      <div class="container mx-auto px-4 sm:px-6 max-w-7xl">
        <h2 id="experience-heading" class="text-4xl font-bold text-center mb-12 text-white">
          {t('experience.title')}
        </h2>
        <div class="max-w-3xl mx-auto space-y-8">
          {experiences.map((exp, index) => (
            <div class="relative pl-8 border-l-2 border-alabaster/50">
              <div class="absolute -left-2 top-0 w-4 h-4 rounded-full bg-alabaster"></div>
              <h3 class="text-2xl font-bold text-alabaster mb-1">{exp.data.company}</h3>
              <p class="text-lg font-semibold text-alabaster/90 mb-1">{t('experience.collaborator')} · {exp.data.role}</p>
              <p class="text-sm text-alabaster/70 mb-2">
                {exp.data.startDate} - {exp.data.endDate || t('experience.present')}
              </p>
              {exp.data.description && (
                <p class="text-alabaster/80">{exp.data.description}</p>
              )}
            </div>
          ))}
        </div>
      </div>
    </section>
    </AuroraBackground>
    </Parallax>

    <!-- About Section -->
    {AboutContent && (
      <Parallax speed={-0.2} client:load>
      <section class="py-12 sm:py-20 bg-alabaster dark:bg-carbon transition-colors relative shadow-2xl" aria-labelledby="about-heading">
        <div class="container mx-auto px-4 sm:px-6 max-w-7xl">
          <h2 id="about-heading" class="text-4xl font-bold text-center mb-12 text-stormy dark:text-seaweed">
            {t('about.title') || 'About Me'}
          </h2>
          <div class="max-w-4xl mx-auto">
            <div class="flex flex-col md:flex-row gap-8 items-start">
              <div class="flex-shrink-0">
                <Image 
                  src={aboutImage} 
                  alt="Airán" 
                  width={200} 
                  height={200}
                  class="rounded-full shadow-lg"
                />
              </div>
              <div class="prose prose-lg dark:prose-invert max-w-none">
                <div class="[&_ul]:list-disc [&_ul>li]:text-carbon dark:[&_ul>li]:text-alabaster [&_ul>li]:marker:text-stormy dark:[&_ul>li]:marker:text-seaweed [&_ul>li]:marker:text-xl">
                  <AboutContent />
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
      </Parallax>
    )}

    <!-- Recent Posts Section -->
    <Parallax speed={0.4} client:load>
      <AuroraBackground className="py-12 sm:py-20" client:load>
      <section class="py-12 sm:py-20 transition-colors relative" aria-labelledby="blog-heading">
      <div class="container mx-auto px-4 sm:px-6 max-w-7xl">
        <h2 id="blog-heading" class="text-4xl font-bold text-center mb-12 text-white">
          {t('blog.title')}
        </h2>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6 sm:gap-8">
          {recentPosts.map((post) => (
            <article 
              class="group transition-transform duration-300 hover:-translate-y-1 focus-within:ring-2 focus-within:ring-stormy rounded-lg"
              data-blog-card
            >
              <Card 
                variant="elevated" 
                padding="lg"
                class="h-full flex flex-col"
              >
                <h3 class="text-xl font-bold mb-2 text-stormy dark:text-seaweed">
                  <Link 
                    href={`/${lang}/blog/${post.slug}/`}
                    variant="subtle"
                    class="hover:underline focus-visible:underline"
                  >
                    {post.data.title}
                  </Link>
                </h3>
                
                <time 
                  datetime={post.data.date.toISOString()}
                  class="text-sm text-carbon/60 dark:text-alabaster/60 mb-3 block"
                >
                  {new Date(post.data.date).toLocaleDateString(lang, {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                  })}
                </time>
                
                <p class="text-carbon/80 dark:text-alabaster/80 mb-4 line-clamp-3 flex-grow">
                  {post.data.description}
                </p>
                
                <div class="flex flex-wrap gap-2 mb-4" role="list" aria-label="Tags">
                  {post.data.tags.slice(0, 3).map((tag) => (
                    <Badge 
                      variant="muted" 
                      size="sm"
                      role="listitem"
                    >
                      {tag}
                    </Badge>
                  ))}
                  {post.data.tags.length > 3 && (
                    <Badge variant="outline" size="sm">
                      +{post.data.tags.length - 3}
                    </Badge>
                  )}
                </div>
                
                <a 
                  href={`/${lang}/blog/${post.slug}/`}
                  class="inline-flex items-center gap-1 text-stormy dark:text-seaweed hover:underline font-semibold transition-all group-hover:gap-2"
                >
                  {t('blog.readMore')} 
                  <span aria-hidden="true">→</span>
                </a>
              </Card>
            </article>
          ))}
        </div>
        <div class="text-center mt-8">
          <Button 
            href={`/${lang}/blog/`}
            size="lg"
            variant="primary"
          >
            {t('blog.viewAll')}
          </Button>
        </div>
      </div>
    </section>
    </AuroraBackground>
    </Parallax>

    <!-- Contact Section -->
    <Parallax speed={-0.1} client:load>
    <section id="contact" class="py-20 bg-alabaster dark:bg-carbon transition-colors relative shadow-2xl" aria-labelledby="contact-heading">
      <div class="container mx-auto px-4 max-w-4xl">
        <div class="max-w-2xl mx-auto">
          <h2 id="contact-heading" class="text-4xl font-bold mb-4 text-stormy dark:text-seaweed text-center">
            {t('contact.title')}
          </h2>
          <p class="text-xl text-carbon/80 dark:text-alabaster/80 mb-8 text-center">
            {t('contact.subtitle')}
          </p>
          
          <form id="contact-form" class="space-y-6 text-left">
            <input type="hidden" name="access_key" value={import.meta.env.WEB3FORMS_ACCESS_KEY || 'your_key_here'} />
            
            <Input
              type="text"
              name="name"
              id="contact-name"
              label={t('contact.name')}
              placeholder={t('contact.name')}
              required={true}
              autocomplete="name"
              inputClass="bg-white dark:bg-stormy/10 text-carbon dark:text-alabaster border-stormy/20 dark:border-seaweed/20"
              class="[&_label]:text-stormy dark:[&_label]:text-seaweed [&_label]:font-semibold [&_label]:text-base"
            />
            
            <Input
              type="email"
              name="email"
              id="contact-email"
              label={t('contact.email')}
              placeholder={t('contact.email')}
              required={true}
              autocomplete="email"
              inputClass="bg-white dark:bg-stormy/10 text-carbon dark:text-alabaster border-stormy/20 dark:border-seaweed/20"
              class="[&_label]:text-stormy dark:[&_label]:text-seaweed [&_label]:font-semibold [&_label]:text-base"
            />
            
            <Textarea
              name="message"
              id="contact-message"
              label={t('contact.message')}
              placeholder={t('contact.message')}
              required={true}
              rows={5}
              maxlength={1000}
              showCharCount={true}
              textareaClass="bg-white dark:bg-stormy/10 text-carbon dark:text-alabaster border-stormy/20 dark:border-seaweed/20"
              class="[&_label]:text-stormy dark:[&_label]:text-seaweed [&_label]:font-semibold [&_label]:text-base [&_.text-xs]:text-carbon/60 dark:[&_.text-xs]:text-alabaster/60"
            />
            
            <!-- Status Messages -->
            <div id="form-status" role="status" aria-live="polite" class="hidden p-4 rounded-lg text-center font-semibold"></div>
            
            <Button
              type="submit"
              size="lg"
              class="w-full"
              id="submit-button"
            >
              {t('contact.send')}
            </Button>
          </form>
        </div>
      </div>
    </section>
    </Parallax>
  </main>

  <Footer />

  <script define:vars={{ lang, translations: { 
    sending: t('contact.sending'),
    success: t('contact.success'),
    error: t('contact.error')
  }}}>
    const form = document.getElementById('contact-form');
    const submitButton = document.getElementById('submit-button');
    const formStatus = document.getElementById('form-status');

    if (form && submitButton && formStatus) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Get form data
        const formData = new FormData(form);

        // Show loading state
        submitButton.disabled = true;
        submitButton.setAttribute('aria-busy', 'true');
        const originalText = submitButton.textContent;
        submitButton.textContent = translations.sending;

        // Hide previous status
        formStatus.classList.add('hidden');

        try {
          // Submit to Web3Forms
          const response = await fetch('https://api.web3forms.com/submit', {
            method: 'POST',
            body: formData
          });

          const data = await response.json();

          if (response.ok && data.success) {
            // Show success message
            formStatus.textContent = translations.success;
            formStatus.className = 'p-4 rounded-lg text-center font-semibold bg-seaweed/20 text-white border border-seaweed/40';
            formStatus.classList.remove('hidden');

            // Reset form
            form.reset();

            // Remove char count if exists
            const charCountEl = document.querySelector('[id^="char-count-"]');
            if (charCountEl) {
              charCountEl.textContent = '0';
            }
          } else {
            throw new Error(data.message || 'Submission failed');
          }
        } catch (error) {
          // Show error message
          formStatus.textContent = translations.error;
          formStatus.className = 'p-4 rounded-lg text-center font-semibold bg-red-500/20 text-white border border-red-500/40';
          formStatus.classList.remove('hidden');
          
          console.error('Form submission error:', error);
        } finally {
          // Reset button state
          submitButton.disabled = false;
          submitButton.removeAttribute('aria-busy');
          submitButton.textContent = originalText;

          // Auto-hide status after 5 seconds
          setTimeout(() => {
            formStatus.classList.add('hidden');
          }, 5000);
        }
      });

      // Warn before leaving if form has unsaved changes
      let formChanged = false;
      const formInputs = form.querySelectorAll('input:not([type="hidden"]), textarea');
      
      formInputs.forEach(input => {
        input.addEventListener('input', () => {
          formChanged = true;
        });
      });

      form.addEventListener('submit', () => {
        formChanged = false;
      });

      window.addEventListener('beforeunload', (e) => {
        if (formChanged) {
          e.preventDefault();
          e.returnValue = '';
        }
      });
    }
  </script>
</Layout>

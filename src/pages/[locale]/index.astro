---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/layout/Header.astro';
import Footer from '../../components/layout/Footer.astro';
import HeroSection from '../../components/home/HeroSection.astro';
import ProjectsSection from '../../components/home/ProjectsSection.astro';
import ExperienceSection from '../../components/home/ExperienceSection.astro';
import AboutSection from '../../components/home/AboutSection.astro';
import BlogSection from '../../components/home/BlogSection.astro';
import ContactSection from '../../components/home/ContactSection.astro';
import { getCollection } from 'astro:content';
import { getLangFromUrl, useTranslations } from '../../logic/i18n-engine';

// Import consolidated experience files
import experiencesEn from '../../data/experience/experiences-en.json';
import experiencesEs from '../../data/experience/experiences-es.json';
import experiencesJa from '../../data/experience/experiences-ja.json';

export const prerender = true;

export function getStaticPaths() {
  return [
    { params: { locale: 'en' } },
    { params: { locale: 'es' } },
    { params: { locale: 'ja' } }
  ];
}

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Get experiences from consolidated files
const experiencesMap: Record<string, any[]> = {
  'en': experiencesEn,
  'es': experiencesEs,
  'ja': experiencesJa
};

const experiences = experiencesMap[lang]
  .sort((a: any, b: any) => b.startDate.localeCompare(a.startDate))
  .map((exp: any, index: number) => ({
    data: exp,
    id: `experience-${index}`
  }));

const allProjects = await getCollection('projects');
const projects = allProjects.filter(proj => proj.data.locale === lang && proj.data.featured);

const allPosts = await getCollection('blog');
const recentPosts = allPosts
  .filter(post => !post.data.draft && post.id.startsWith(`${lang}/`))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 3);

const aboutEntry = await getCollection('about');
const about = aboutEntry.find(entry => entry.id === `${lang}.mdx`);
const { Content: AboutContent } = about ? await about.render() : { Content: null };
---

<Layout title={`AirÃ¡n - ${t('hero.subtitle')}`} description={t('hero.subtitle')} lang={lang}>
  <Header />
  
  <main id="main-content" class="relative">
    <HeroSection t={t} lang={lang} />
    <ProjectsSection projects={projects} t={t} />
    <ExperienceSection experiences={experiences} t={t} lang={lang} />
    {AboutContent && <AboutSection Content={AboutContent} t={t} />}
    <BlogSection posts={recentPosts} t={t} lang={lang} />
    <ContactSection t={t} />
  </main>

  <Footer />
</Layout>

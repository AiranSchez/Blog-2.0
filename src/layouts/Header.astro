---
import { getLangFromUrl, useTranslations } from '../services/i18n';
import AnimatedText from '../components/shared/react/common/AnimatedText.tsx';
// import { Sun, Moon, Languages, Menu, X } from '@lucide/astro';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Get current path without locale for language switching
const pathWithoutLocale = Astro.url.pathname.replace(/^\/(en|es|ja)/, '') || '/';
---

<!-- Skip to main content link for keyboard navigation -->
<a href="#main-content" class="skip-to-main">
  {t('nav.skipToContent') || 'Skip to main content'}
</a>

<header class="sticky top-0 z-[var(--z-sticky)] bg-alabaster/90 dark:bg-carbon/90 backdrop-blur-sm border-b border-muted/20 dark:border-stormy/20 transition-colors duration-300">
  <nav class="container-custom py-4" aria-label="Main navigation">
    <div class="flex items-center justify-between">
      <!-- Logo / Brand -->
      <a 
        href={`/${lang}/`} 
        class="text-2xl font-bold text-stormy dark:text-seaweed hover:text-seaweed dark:hover:text-muted transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-stormy rounded px-2 py-1"
      >
        <AnimatedText 
          text="AirÃ¡n Sanchez"
          variant="typewriter"
          client:load
        />
      </a>
      
      <!-- Desktop Navigation -->
      <div class="hidden md:flex items-center gap-6">
        <a 
          href={`/${lang}/`} 
          class="text-carbon dark:text-alabaster hover:text-stormy dark:hover:text-seaweed transition-colors font-medium focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-stormy rounded px-2 py-1"
        >
          {t('nav.home')}
        </a>
        <a 
          href={`/${lang}/blog/`}
          class="text-carbon dark:text-alabaster hover:text-stormy dark:hover:text-seaweed transition-colors font-medium focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-stormy rounded px-2 py-1"
        >
          {t('nav.blog')}
        </a>
        <a 
          href={`/${lang}/podcast/`}
          class="text-carbon dark:text-alabaster hover:text-stormy dark:hover:text-seaweed transition-colors font-medium focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-stormy rounded px-2 py-1"
        >
          {t('nav.podcast')}
        </a>
        
        <div class="flex items-center gap-2 ml-4 border-l border-muted/20 dark:border-stormy/20 pl-4">
          <!-- Theme Toggle -->
          <button 
            id="theme-toggle" 
            type="button"
            aria-label="Toggle theme"
            class="p-2 sm:p-2.5 min-w-[44px] min-h-[44px] rounded-lg hover:bg-muted/20 dark:hover:bg-stormy/20 transition-all duration-300 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-stormy touch-manipulation"
          >
            <svg id="theme-icon-light" class="w-6 h-6 hidden dark:block" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="4"/>
              <path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41m11.32 11.32l1.41 1.41M2 12h2m16 0h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/>
            </svg>
            <svg id="theme-icon-dark" class="w-6 h-6 block dark:hidden" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
            </svg>
          </button>
          
          <!-- Language Switcher -->
          <div class="relative">
            <button
              id="language-toggle"
              type="button"
              aria-label="Change language"
              aria-haspopup="true"
              aria-expanded="false"
              aria-controls="language-dropdown"
              class="p-2 sm:p-2.5 min-w-[44px] min-h-[44px] rounded-lg hover:bg-muted/20 dark:hover:bg-stormy/20 transition-all duration-300 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-stormy touch-manipulation"
            >
              <svg class="w-6 h-6" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"/>
                <path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
              </svg>
            </button>
            
            <div
              id="language-dropdown"
              role="menu"
              aria-labelledby="language-toggle"
              class="absolute right-0 mt-2 w-40 bg-white dark:bg-carbon-700 border border-alabaster-300 dark:border-carbon-600 rounded-lg shadow-strong opacity-0 invisible scale-95 transition-all duration-200 origin-top-right"
            >
              <a 
                href={`/en${pathWithoutLocale}`}
                role="menuitem"
                lang="en"
                hreflang="en"
                class="block px-4 py-2.5 hover:bg-muted/10 dark:hover:bg-stormy/10 transition-colors first:rounded-t-lg last:rounded-b-lg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-inset focus-visible:ring-stormy"
                data-lang="en"
              >
                ðŸ‡¬ðŸ‡§ English
              </a>
              <a 
                href={`/es${pathWithoutLocale}`}
                role="menuitem"
                lang="es"
                hreflang="es"
                class="block px-4 py-2.5 hover:bg-muted/10 dark:hover:bg-stormy/10 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-inset focus-visible:ring-stormy"
                data-lang="es"
              >
                ðŸ‡ªðŸ‡¸ EspaÃ±ol
              </a>
              <a 
                href={`/ja${pathWithoutLocale}`}
                role="menuitem"
                lang="ja"
                hreflang="ja"
                class="block px-4 py-2.5 hover:bg-muted/10 dark:hover:bg-stormy/10 transition-colors last:rounded-b-lg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-inset focus-visible:ring-stormy"
                data-lang="ja"
              >
                ðŸ‡¯ðŸ‡µ æ—¥æœ¬èªž
              </a>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Mobile Menu Button -->
      <button
        id="mobile-menu-toggle"
        type="button"
        aria-label="Toggle mobile menu"
        aria-expanded="false"
        aria-controls="mobile-menu"
        class="md:hidden p-2.5 min-w-[48px] min-h-[48px] rounded-lg hover:bg-muted/20 dark:hover:bg-stormy/20 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-stormy touch-manipulation"
      >
        <svg id="mobile-menu-icon-open" class="w-7 h-7" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
        <svg id="mobile-menu-icon-close" class="w-7 h-7 hidden" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    
    <!-- Mobile Menu -->
    <div
      id="mobile-menu"
      class="md:hidden hidden mt-4 pt-4 border-t border-muted/20 dark:border-stormy/20 animate-[slideDown_200ms_ease-out]"
    >
      <nav class="flex flex-col gap-3" aria-label="Mobile navigation">
        <a 
          href={`/${lang}/`}
          class="text-carbon dark:text-alabaster hover:text-stormy dark:hover:text-seaweed transition-colors font-medium px-2 py-2 rounded focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-stormy"
        >
          {t('nav.home')}
        </a>
        <a 
          href={`/${lang}/blog/`}
          class="text-carbon dark:text-alabaster hover:text-stormy dark:hover:text-seaweed transition-colors font-medium px-2 py-2 rounded focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-stormy"
        >
          {t('nav.blog')}
        </a>
        <a 
          href={`/${lang}/podcast/`}
          class="text-carbon dark:text-alabaster hover:text-stormy dark:hover:text-seaweed transition-colors font-medium px-2 py-2 rounded focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-stormy"
        >
          {t('nav.podcast')}
        </a>
        
        <div class="pt-3 mt-3 border-t border-muted/20 dark:border-stormy/20 flex flex-col gap-2">
          <span class="text-xs uppercase text-alabaster-600 dark:text-carbon-400 font-semibold px-2">
            {t('nav.settings') || 'Settings'}
          </span>
          
          <button
            id="mobile-theme-toggle"
            type="button"
            class="flex items-center gap-3 text-carbon dark:text-alabaster hover:text-stormy dark:hover:text-seaweed transition-colors font-medium px-3 py-3 min-h-[48px] rounded focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-stormy text-left touch-manipulation"
          >
            <svg class="w-6 h-6 hidden dark:block" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="4"/>
              <path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41m11.32 11.32l1.41 1.41M2 12h2m16 0h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/>
            </svg>
            <svg class="w-6 h-6 block dark:hidden" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
            </svg>
            <span id="mobile-theme-text">
              {t('nav.lightMode')}
            </span>
          </button>
          
          <div class="flex flex-col gap-1">
            <span class="text-xs uppercase text-alabaster-600 dark:text-carbon-400 font-semibold px-2 mb-1">
              {t('nav.language') || 'Language'}
            </span>
            <a 
              href={`/en${pathWithoutLocale}`}
              class="flex items-center gap-3 text-carbon dark:text-alabaster hover:text-stormy dark:hover:text-seaweed transition-colors px-3 py-3 min-h-[48px] rounded focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-stormy"
            >
              ðŸ‡¬ðŸ‡§ English
            </a>
            <a 
              href={`/es${pathWithoutLocale}`}
              class="flex items-center gap-3 text-carbon dark:text-alabaster hover:text-stormy dark:hover:text-seaweed transition-colors px-3 py-3 min-h-[48px] rounded focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-stormy"
            >
              ðŸ‡ªðŸ‡¸ EspaÃ±ol
            </a>
            <a 
              href={`/ja${pathWithoutLocale}`}
              class="flex items-center gap-3 text-carbon dark:text-alabaster hover:text-stormy dark:hover:text-seaweed transition-colors px-3 py-3 min-h-[48px] rounded focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-stormy"
            >
              ðŸ‡¯ðŸ‡µ æ—¥æœ¬èªž
            </a>
          </div>
        </div>
      </nav>
    </div>
  </nav>
</header>

<script>
  // Simplified Header scripts for performance
  
  // Theme toggle
  const themeToggle = document.getElementById('theme-toggle');
  const mobileThemeToggle = document.getElementById('mobile-theme-toggle');
  const mobileThemeText = document.getElementById('mobile-theme-text');

  function updateThemeText() {
    if (mobileThemeText) {
      const isDark = document.documentElement.classList.contains('dark');
      mobileThemeText.textContent = isDark ? 'Light Mode' : 'Dark Mode';
    }
  }

  function toggleTheme() {
    const html = document.documentElement;
    const isDark = html.classList.contains('dark');
    
    if (isDark) {
      html.classList.remove('dark');
      html.style.colorScheme = 'light';
      localStorage.setItem('theme', 'light');
      // Update meta theme-color for browser chrome
      document.querySelector('meta[name="theme-color"]')?.setAttribute('content', '#dce1de');
    } else {
      html.classList.add('dark');
      html.style.colorScheme = 'dark';
      localStorage.setItem('theme', 'dark');
      // Update meta theme-color for browser chrome
      document.querySelector('meta[name="theme-color"]')?.setAttribute('content', '#1f2421');
    }
    
    updateThemeText();
  }

  updateThemeText();
  themeToggle?.addEventListener('click', toggleTheme);
  mobileThemeToggle?.addEventListener('click', toggleTheme);

  // Language dropdown
  const languageToggle = document.getElementById('language-toggle');
  const languageDropdown = document.getElementById('language-dropdown');
  
  if (languageToggle && languageDropdown) {
    languageToggle.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = languageToggle.getAttribute('aria-expanded') === 'true';
      languageToggle.setAttribute('aria-expanded', String(!isOpen));
      languageDropdown.classList.toggle('opacity-0');
      languageDropdown.classList.toggle('invisible');
    });

    document.addEventListener('click', () => {
      languageToggle.setAttribute('aria-expanded', 'false');
      languageDropdown.classList.add('opacity-0', 'invisible');
    });
  }

  // Mobile menu
  const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
  const mobileMenu = document.getElementById('mobile-menu');
  const iconOpen = document.getElementById('mobile-menu-icon-open');
  const iconClose = document.getElementById('mobile-menu-icon-close');

  if (mobileMenuToggle && mobileMenu) {
    mobileMenuToggle.addEventListener('click', () => {
      const isOpen = mobileMenuToggle.getAttribute('aria-expanded') === 'true';
      mobileMenuToggle.setAttribute('aria-expanded', String(!isOpen));
      mobileMenu.classList.toggle('hidden');
      iconOpen?.classList.toggle('hidden');
      iconClose?.classList.toggle('hidden');
    });
  }
</script>

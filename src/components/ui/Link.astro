---
import { cva, type VariantProps } from 'class-variance-authority';
import { cn } from '@/lib/utils';

const linkVariants = cva(
  // Base styles for all links
  'inline-flex items-center gap-1 transition-all duration-300 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-stormy focus-visible:ring-offset-2 rounded touch-manipulation',
  {
    variants: {
      variant: {
        default:
          'text-stormy hover:text-stormy-700 underline decoration-stormy/30 hover:decoration-stormy underline-offset-4',
        subtle:
          'text-carbon dark:text-alabaster hover:text-stormy dark:hover:text-stormy-400 no-underline hover:underline underline-offset-4',
        button:
          'no-underline font-medium px-4 py-2 rounded-lg bg-stormy text-white hover:bg-stormy-600 active:bg-stormy-700 shadow-md hover:shadow-lg',
        nav:
          'text-carbon dark:text-alabaster hover:text-stormy dark:hover:text-stormy-400 no-underline font-medium',
      },
    },
    defaultVariants: {
      variant: 'default',
    },
  }
);

export interface Props extends VariantProps<typeof linkVariants> {
  href: string;
  target?: '_blank' | '_self' | '_parent' | '_top';
  rel?: string;
  class?: string;
  'aria-label'?: string;
  showExternalIcon?: boolean;
}

const {
  href,
  target,
  rel,
  variant,
  class: className,
  'aria-label': ariaLabel,
  showExternalIcon = true,
  ...props
} = Astro.props;

// Detect external links
const isExternal = href.startsWith('http') || href.startsWith('//');
const isDownload = href.includes('/download') || href.endsWith('.pdf') || href.endsWith('.zip');

// Auto-add security attributes for external links
const computedTarget = target || (isExternal ? '_blank' : undefined);
const computedRel = computedTarget === '_blank' 
  ? (rel || 'noopener noreferrer')
  : rel;

// Accessibility label for external links
const computedAriaLabel = ariaLabel || (isExternal && !ariaLabel ? `${href} (opens in new tab)` : undefined);
---

<a
  href={href}
  target={computedTarget}
  rel={computedRel}
  aria-label={computedAriaLabel}
  class={cn(linkVariants({ variant }), className)}
  {...props}
>
  <slot />
  
  {isExternal && showExternalIcon && variant !== 'button' && (
    <svg
      class="w-4 h-4 inline-block"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      aria-hidden="true"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
      />
    </svg>
  )}
  
  {isDownload && (
    <svg
      class="w-4 h-4 inline-block"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      aria-hidden="true"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
      />
    </svg>
  )}
</a>

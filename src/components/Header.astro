---
import { getLangFromUrl, useTranslations } from '../i18n/utils';
import { Sun, Moon, Languages, Menu, X } from '@lucide/astro';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Get current path without locale for language switching
const pathWithoutLocale = Astro.url.pathname.replace(/^\/(en|es|ja)/, '') || '/';
---

<!-- Skip to main content link for keyboard navigation -->
<a href="#main-content" class="skip-to-main">
  {t('nav.skipToContent') || 'Skip to main content'}
</a>

<header class="sticky top-0 z-[var(--z-sticky)] bg-alabaster/90 dark:bg-carbon/90 backdrop-blur-sm border-b border-muted/20 dark:border-stormy/20 transition-colors duration-300">
  <nav class="container-custom py-4" aria-label="Main navigation">
    <div class="flex items-center justify-between">
      <!-- Logo / Brand -->
      <a 
        href={`/${lang}/`} 
        class="text-2xl font-bold text-stormy dark:text-seaweed hover:text-seaweed dark:hover:text-muted transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-stormy rounded px-2 py-1"
      >
        AirÃ¡n Sanchez
      </a>
      
      <!-- Desktop Navigation -->
      <div class="hidden md:flex items-center gap-6">
        <a 
          href={`/${lang}/`} 
          class="text-carbon dark:text-alabaster hover:text-stormy dark:hover:text-seaweed transition-colors font-medium focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-stormy rounded px-2 py-1"
        >
          {t('nav.home')}
        </a>
        <a 
          href={`/${lang}/blog/`}
          class="text-carbon dark:text-alabaster hover:text-stormy dark:hover:text-seaweed transition-colors font-medium focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-stormy rounded px-2 py-1"
        >
          {t('nav.blog')}
        </a>
        
        <div class="flex items-center gap-2 ml-4 border-l border-muted/20 dark:border-stormy/20 pl-4">
          <!-- Theme Toggle -->
          <button 
            id="theme-toggle" 
            type="button"
            aria-label="Toggle theme"
            class="p-2 rounded-lg hover:bg-muted/20 dark:hover:bg-stormy/20 transition-all duration-300 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-stormy touch-manipulation"
          >
            <Sun id="theme-icon-light" class="w-5 h-5 hidden dark:block" aria-hidden="true" />
            <Moon id="theme-icon-dark" class="w-5 h-5 block dark:hidden" aria-hidden="true" />
          </button>
          
          <!-- Language Switcher -->
          <div class="relative">
            <button
              id="language-toggle"
              type="button"
              aria-label="Change language"
              aria-haspopup="true"
              aria-expanded="false"
              aria-controls="language-dropdown"
              class="p-2 rounded-lg hover:bg-muted/20 dark:hover:bg-stormy/20 transition-all duration-300 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-stormy touch-manipulation"
            >
              <Languages class="w-5 h-5" aria-hidden="true" />
            </button>
            
            <div
              id="language-dropdown"
              role="menu"
              aria-labelledby="language-toggle"
              class="absolute right-0 mt-2 w-40 bg-white dark:bg-carbon-700 border border-alabaster-300 dark:border-carbon-600 rounded-lg shadow-strong opacity-0 invisible scale-95 transition-all duration-200 origin-top-right"
            >
              <a 
                href={`/en${pathWithoutLocale}`}
                role="menuitem"
                lang="en"
                hreflang="en"
                class="block px-4 py-2.5 hover:bg-muted/10 dark:hover:bg-stormy/10 transition-colors first:rounded-t-lg last:rounded-b-lg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-inset focus-visible:ring-stormy"
                data-lang="en"
              >
                ðŸ‡¬ðŸ‡§ English
              </a>
              <a 
                href={`/es${pathWithoutLocale}`}
                role="menuitem"
                lang="es"
                hreflang="es"
                class="block px-4 py-2.5 hover:bg-muted/10 dark:hover:bg-stormy/10 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-inset focus-visible:ring-stormy"
                data-lang="es"
              >
                ðŸ‡ªðŸ‡¸ EspaÃ±ol
              </a>
              <a 
                href={`/ja${pathWithoutLocale}`}
                role="menuitem"
                lang="ja"
                hreflang="ja"
                class="block px-4 py-2.5 hover:bg-muted/10 dark:hover:bg-stormy/10 transition-colors last:rounded-b-lg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-inset focus-visible:ring-stormy"
                data-lang="ja"
              >
                ðŸ‡¯ðŸ‡µ æ—¥æœ¬èªž
              </a>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Mobile Menu Button -->
      <button
        id="mobile-menu-toggle"
        type="button"
        aria-label="Toggle mobile menu"
        aria-expanded="false"
        aria-controls="mobile-menu"
        class="md:hidden p-2 rounded-lg hover:bg-muted/20 dark:hover:bg-stormy/20 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-stormy touch-manipulation"
      >
        <Menu id="mobile-menu-icon-open" class="w-6 h-6" aria-hidden="true" />
        <X id="mobile-menu-icon-close" class="w-6 h-6 hidden" aria-hidden="true" />
      </button>
    </div>
    
    <!-- Mobile Menu -->
    <div
      id="mobile-menu"
      class="md:hidden hidden mt-4 pt-4 border-t border-muted/20 dark:border-stormy/20"
    >
      <nav class="flex flex-col gap-3" aria-label="Mobile navigation">
        <a 
          href={`/${lang}/`}
          class="text-carbon dark:text-alabaster hover:text-stormy dark:hover:text-seaweed transition-colors font-medium px-2 py-2 rounded focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-stormy"
        >
          {t('nav.home')}
        </a>
        <a 
          href={`/${lang}/blog/`}
          class="text-carbon dark:text-alabaster hover:text-stormy dark:hover:text-seaweed transition-colors font-medium px-2 py-2 rounded focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-stormy"
        >
          {t('nav.blog')}
        </a>
        
        <div class="pt-3 mt-3 border-t border-muted/20 dark:border-stormy/20 flex flex-col gap-2">
          <span class="text-xs uppercase text-alabaster-600 dark:text-carbon-400 font-semibold px-2">
            {t('nav.settings') || 'Settings'}
          </span>
          
          <button
            id="mobile-theme-toggle"
            type="button"
            class="flex items-center gap-3 text-carbon dark:text-alabaster hover:text-stormy dark:hover:text-seaweed transition-colors font-medium px-2 py-2 rounded focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-stormy text-left touch-manipulation"
          >
            <Sun class="w-5 h-5 hidden dark:block" aria-hidden="true" />
            <Moon class="w-5 h-5 block dark:hidden" aria-hidden="true" />
            <span id="mobile-theme-text">
              {t('nav.theme') || 'Theme'}
            </span>
          </button>
          
          <div class="flex flex-col gap-1">
            <span class="text-xs uppercase text-alabaster-600 dark:text-carbon-400 font-semibold px-2 mb-1">
              {t('nav.language') || 'Language'}
            </span>
            <a 
              href={`/en${pathWithoutLocale}`}
              class="flex items-center gap-3 text-carbon dark:text-alabaster hover:text-stormy dark:hover:text-seaweed transition-colors px-2 py-2 rounded focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-stormy"
            >
              ðŸ‡¬ðŸ‡§ English
            </a>
            <a 
              href={`/es${pathWithoutLocale}`}
              class="flex items-center gap-3 text-carbon dark:text-alabaster hover:text-stormy dark:hover:text-seaweed transition-colors px-2 py-2 rounded focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-stormy"
            >
              ðŸ‡ªðŸ‡¸ EspaÃ±ol
            </a>
            <a 
              href={`/ja${pathWithoutLocale}`}
              class="flex items-center gap-3 text-carbon dark:text-alabaster hover:text-stormy dark:hover:text-seaweed transition-colors px-2 py-2 rounded focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-stormy"
            >
              ðŸ‡¯ðŸ‡µ æ—¥æœ¬èªž
            </a>
          </div>
        </div>
      </nav>
    </div>
  </nav>
</header>

<script>
  // Theme toggle functionality
  function initThemeToggle() {
    const themeToggle = document.getElementById('theme-toggle');
    const mobileThemeToggle = document.getElementById('mobile-theme-toggle');
    const mobileThemeText = document.getElementById('mobile-theme-text');
    
    if (!themeToggle) return;

    // Set initial theme text
    function updateThemeText() {
      if (mobileThemeText) {
        const isDark = document.documentElement.classList.contains('dark');
        mobileThemeText.textContent = isDark ? 'Light Mode' : 'Dark Mode';
      }
    }

    function toggleTheme() {
      const isDark = document.documentElement.classList.contains('dark');
      
      if (isDark) {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('theme', 'light');
      } else {
        document.documentElement.classList.add('dark');
        localStorage.setItem('theme', 'dark');
      }
      
      // Update mobile theme text
      updateThemeText();
    }

    // Initialize theme text on load
    updateThemeText();

    // Remove old listeners by cloning
    const newThemeToggle = themeToggle.cloneNode(true);
    themeToggle.parentNode?.replaceChild(newThemeToggle, themeToggle);
    newThemeToggle.addEventListener('click', toggleTheme);
    
    if (mobileThemeToggle) {
      const newMobileToggle = mobileThemeToggle.cloneNode(true);
      mobileThemeToggle.parentNode?.replaceChild(newMobileToggle, mobileThemeToggle);
      newMobileToggle.addEventListener('click', toggleTheme);
    }
  }

  // Language dropdown functionality
  function initLanguageDropdown() {
    const languageToggle = document.getElementById('language-toggle');
    const languageDropdown = document.getElementById('language-dropdown');
    
    if (!languageToggle || !languageDropdown) return;

    let isOpen = false;

    function openDropdown() {
      isOpen = true;
      languageToggle?.setAttribute('aria-expanded', 'true');
      languageDropdown?.classList.remove('opacity-0', 'invisible', 'scale-95');
      languageDropdown?.classList.add('opacity-100', 'visible', 'scale-100');
    }

    function closeDropdown() {
      isOpen = false;
      languageToggle?.setAttribute('aria-expanded', 'false');
      languageDropdown?.classList.add('opacity-0', 'invisible', 'scale-95');
      languageDropdown?.classList.remove('opacity-100', 'visible', 'scale-100');
    }

    // Toggle on button click
    const newLanguageToggle = languageToggle.cloneNode(true);
    languageToggle.parentNode?.replaceChild(newLanguageToggle, languageToggle);
    
    newLanguageToggle.addEventListener('click', (e) => {
      e.stopPropagation();
      isOpen ? closeDropdown() : openDropdown();
    });

    // Close on outside click
    document.addEventListener('click', (e) => {
      if (isOpen && !newLanguageToggle.contains(e.target as Node) && !languageDropdown?.contains(e.target as Node)) {
        closeDropdown();
      }
    });

    // Close on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isOpen) {
        closeDropdown();
        newLanguageToggle.focus();
      }
    });

    // Handle keyboard navigation in dropdown
    const menuItems = languageDropdown?.querySelectorAll('[role="menuitem"]');
    menuItems?.forEach((item, index) => {
      item.addEventListener('keydown', (e) => {
        const key = (e as KeyboardEvent).key;
        
        if (key === 'ArrowDown') {
          e.preventDefault();
          const nextItem = menuItems[index + 1] as HTMLElement;
          if (nextItem) nextItem.focus();
        } else if (key === 'ArrowUp') {
          e.preventDefault();
          const prevItem = menuItems[index - 1] as HTMLElement;
          if (prevItem) {
            prevItem.focus();
          } else {
            closeDropdown();
            newLanguageToggle.focus();
          }
        }
      });
    });
  }

  // Mobile menu functionality
  function initMobileMenu() {
    const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
    const mobileMenu = document.getElementById('mobile-menu');
    const iconOpen = document.getElementById('mobile-menu-icon-open');
    const iconClose = document.getElementById('mobile-menu-icon-close');
    
    if (!mobileMenuToggle || !mobileMenu) return;

    let isOpen = false;

    function toggleMobileMenu() {
      isOpen = !isOpen;
      mobileMenuToggle?.setAttribute('aria-expanded', String(isOpen));
      
      if (isOpen) {
        mobileMenu?.classList.remove('hidden');
        iconOpen?.classList.add('hidden');
        iconClose?.classList.remove('hidden');
      } else {
        mobileMenu?.classList.add('hidden');
        iconOpen?.classList.remove('hidden');
        iconClose?.classList.add('hidden');
      }
    }

    const newMobileToggle = mobileMenuToggle.cloneNode(true);
    mobileMenuToggle.parentNode?.replaceChild(newMobileToggle, mobileMenuToggle);
    newMobileToggle.addEventListener('click', toggleMobileMenu);
  }

  // Initialize all on first load
  initThemeToggle();
  initLanguageDropdown();
  initMobileMenu();

  // Re-initialize after view transitions
  document.addEventListener('astro:after-swap', () => {
    initThemeToggle();
    initLanguageDropdown();
    initMobileMenu();
  });
</script>

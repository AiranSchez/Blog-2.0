---
import Parallax from '../decorators/Parallax.tsx';
import AuroraBackground from '../decorators/AuroraBackground.tsx';
import AnimatedTimeline from '../ui/AnimatedTimeline.tsx';
import ExperienceCard from '../ui/ExperienceCard.tsx';
import DualLogo from '../ui/DualLogo.tsx';

// Import logos
import leanmindLogo from '../../assets/images/leanmind-logo.jpg';
import clarityLogo from '../../assets/images/clarity-logo.png';
import tiiLogo from '../../assets/images/TII-logo.jpg';
import voxelLogo from '../../assets/images/voxelgroup-logo.jpeg';

interface ExperienceData {
  company: string;
  role: string;
  startDate: string;
  endDate: string | null;
  description?: string;
  skills?: string[];
  technologies?: string[];
  locale: string;
}

interface Props {
  experiences: { id: string; data: ExperienceData }[];
  t: (key: any) => string;
  lang: string;
}

const { experiences, t, lang } = Astro.props;

// Logo mapping
const companyLogos: Record<string, string> = {
  'clarity': clarityLogo.src,
  'tii': tiiLogo.src,
  'technology innovation institute': tiiLogo.src,
  'voxel': voxelLogo.src,
  'leanmind': leanmindLogo.src,
};

// Company URL mapping
const companyUrls: Record<string, string> = {
  'clarity': 'https://clarity.ai',
  'tii': 'https://www.tii.ae',
  'technology innovation institute': 'https://www.tii.ae',
  'voxel': 'https://voxelgroup.net',
  'leanmind': 'https://leanmind.es',
};

// Calculate duration between two dates with i18n
function calculateDuration(startDate: string, endDate: string | null, t: any): string {
  const start = new Date(startDate + '-01');
  const end = endDate ? new Date(endDate + '-01') : new Date();
  
  const months = (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth());
  const years = Math.floor(months / 12);
  const remainingMonths = months % 12;
  
  if (years === 0) {
    const monthWord = remainingMonths === 1 
      ? t('experience.duration.month') 
      : t('experience.duration.months');
    return `${remainingMonths} ${monthWord}`;
  } else if (remainingMonths === 0) {
    const yearWord = years === 1 
      ? t('experience.duration.year') 
      : t('experience.duration.years');
    return `${years} ${yearWord}`;
  } else {
    const yearWord = years === 1  
      ? t('experience.duration.year') 
      : t('experience.duration.years');
    const monthWord = remainingMonths === 1 
      ? t('experience.duration.month') 
      : t('experience.duration.months');
    return `${years} ${yearWord} ${t('experience.duration.and')} ${remainingMonths} ${monthWord}`;
  }
}

// Get company logo
function getCompanyLogo(companyName: string): string | undefined {
  const normalized = companyName.toLowerCase();
  
  // If company name contains a dash, extract the part after "leanmind -"
  if (normalized.includes('leanmind -')) {
    const companyPart = normalized.split('leanmind -')[1].trim();
    
    // Search for logo using the company part first
    for (const [key, logo] of Object.entries(companyLogos)) {
      if (key !== 'leanmind' && companyPart.includes(key)) {
        return logo;
      }
    }
  }
  
  // Fallback: search in full name (but skip 'leanmind' key if it's a collaboration)
  for (const [key, logo] of Object.entries(companyLogos)) {
    if (normalized.includes('-') && key === 'leanmind') {
      continue; // Skip leanmind logo for collaborations
    }
    if (normalized.includes(key)) {
      return logo;
    }
  }
  
  return undefined;
}

// Get company URL
function getCompanyUrl(companyName: string): string | undefined {
  const normalized = companyName.toLowerCase();
  
  // If company name contains a dash, extract the part after "leanmind -"
  if (normalized.includes('leanmind -')) {
    const companyPart = normalized.split('leanmind -')[1].trim();
    
    // Search for URL using the company part first
    for (const [key, url] of Object.entries(companyUrls)) {
      if (key !== 'leanmind' && companyPart.includes(key)) {
        return url;
      }
    }
  }
  
  // Fallback: search in full name
  for (const [key, url] of Object.entries(companyUrls)) {
    if (normalized.includes(key)) {
      return url;
    }
  }
  
  return undefined;
}

// Check if it's LeanMind only
function isLeanMindOnly(companyName: string): boolean {
  const normalized = companyName.toLowerCase();
  return normalized === 'leanmind' || !normalized.includes('-');
}

// Prepare experience data
const experiencesWithData = experiences.map((exp, index) => ({
  ...exp.data,
  duration: calculateDuration(exp.data.startDate, exp.data.endDate, t),
  companyLogo: getCompanyLogo(exp.data.company),
  companyUrl: getCompanyUrl(exp.data.company),
  isLeanMindOnly: isLeanMindOnly(exp.data.company),
  skills: exp.data.skills || [],
  technologies: exp.data.technologies || [],
  index,
}));
---

<Parallax speed={0.4} client:load>
  <AuroraBackground className="py-12 sm:py-20" client:load>
    <section class="py-12 sm:py-20 transition-colors relative" aria-labelledby="experience-heading">
      <div class="container mx-auto px-4 sm:px-6 max-w-7xl">
        <h2 id="experience-heading" class="text-4xl font-bold text-center mb-16 text-white">
          {t('experience.title')}
        </h2>
        
        <div class="max-w-4xl mx-auto">
          <AnimatedTimeline client:load>
            {experiencesWithData.map((exp) => (
              <div class="mb-12">
                {/* Logo Section */}
                <DualLogo
                  leanmindLogo={leanmindLogo.src}
                  leanmindUrl={companyUrls.leanmind}
                  companyLogo={exp.companyLogo}
                  companyUrl={exp.companyUrl}
                  companyName={exp.company}
                  isLeanMindOnly={exp.isLeanMindOnly}
                  client:load
                />
                
                {/* Experience Card */}
                <ExperienceCard
                  company={exp.company}
                  role={exp.role}
                  startDate={exp.startDate}
                  endDate={exp.endDate}
                  duration={exp.duration}
                  description={exp.description}
                  skills={exp.skills}
                  technologies={exp.technologies}
                  index={exp.index}
                  lang={lang}
                  presentText={t('experience.present')}
                  client:load
                />
              </div>
            ))}
          </AnimatedTimeline>
        </div>
      </div>
    </section>
  </AuroraBackground>
</Parallax>
